'use strict';

// var $ = require('jquery');
var $ = window.$;
$.ajaxSetup({
  timout: 10 * 60 * 1000
});

$.mockjax({
    url: '/api/friendships/moments/members/ids.json?source=445670032&uid=1702079711', 
    responseText: {"ids":[2292765573,1848934297,2667547537,2350413305,1971077767,1835081243,3314094815,1265956604,1903571803,1882249567,1937927114,3265646961,2173802264,1849036501,1960385877,1052544000,2592104570,1904264861,2231440955,1644557924,1553640407,3043369172,2898430554,2412001441,2799269390,1769055402,1747424947,2246537374,2159859270,2217266142,2483190631,1745485535],"total_numbe":32}
});
var mockdatas = {
    2292765573: {"ids":[1876404817,2513095355,1381513101,1762253415,1996890403,1401798345,1667632085,2179384075,1314904510,2300880622,2272983007,2673106753,3017021023,5325134210,2468609650,2825900260,1678388203,1702079711,3270239731,1052544000,1848934297,2667547537,3836876212,2458219537,1611937785,1449551713,1660538207,1882249567,1748120275,1644675831,2116343300,1279364212,1684366745,2514894543,3086476021,1048963285,1715073465,1677239930,1842764931,2100485500,2108914200,2432523747,1420141112,1739442960,1789482231,2394310933,1978456014,1729615462,2123387657,1216532917,1766665222,5097847213,1452998965,3305356297,2134277207,1916529964,1798045477,1402242027,2104949825,3249457354,1781873197,2350413305,1959021425,1296380977,1740652783,2953300205,3268827915,2161259832,1796084227,1784460047,1818693654,2592104570,1069899692,2389652850,1895004995,2470298677,2764776010,1674276964,2391586622,1764160507,1594954855,1511480232,2427818294,2085126801,1905384815,1781105657,1169936113,2084500011,2412669970,1948425151,1494777880,1868875603,1685428684,1789811857,1362623830,2090473114,1784981197,1782523695,1930696444,1566877913,2529604532,1728565101,2174757575,2410349327,1672075763,2137406213,2049689885,1685427033,2259079072,1237213123,2075561227,2195055487,1994643615,1862665435,1321668973,1055693417,1624087025],"total_numbe":117},
    1848934297: {"ids":[1446570735,1381491061,2480216691,2024315974,1259802183,5325134210,2292765573,2468609650,1676500222,1657303594,1904264861,1619905711,2231440955,1646086142,1875549583,1767115775,3223614115,3710404682,1849036501,1702079711,1574122511,2129192603,2825900260,2667547537,1882249567,3017021023,1265956604,1052544000,2384735762,2350413305,5203506211,1678388203,1835081243,1665947213,1629216490,3965217106,2607250441,2744868741],"total_numbe":38},
    2667547537: {"ids":[1803109747,2468609650,2292765573,2518284175,1702079711,3017021023,2384735762,2825900260,1052544000,1678388203,1848934297,1265956604,2513266134,2219574291,1813682862,5182111954,1882249567,2350413305,1942500441,1869398105,2835256243,1749255123,2679140023,1889788555,1822590137,2675937321,2667806331,3056363753,2595808524,3039030951,2352872161,2468568807,2480171722,2328455105],"total_numbe":34},
    2350413305: {"ids":[1660579792,3613247654,2275577663,1834187957,1750060965,1403084765,2776891611,1996890403,1762253415,1268478282,1491037034,1865163525,2093717553,5325134210,3270239731,2468609650,1758600355,1714394333,1281167662,2120640717,1863725793,1069300760,1616240402,1272609197,1420156545,2384735762,1678388203,1574122511,3017021023,2825900260,1848934297,1381513101,1231654585,1458085847,1695436285,1702079711,1735775745,1662680107,1812706462,1765972834,1866299417,5288322822,1808256201,1870948374,2696331421,1157485027,2513292190,1903571803,2123387657,1052544000,1232482597,1882249567,2667547537,2301035025,1601189602,1217434192,2106588943,2041014273,1043848755,1666473521,1478641362,1709486173,2295099772,1118792917,1962357354,2287423461,2467311484,1510293053,2254920687,2061032591,1855640253,1667844931,1150335323,1075913170,1481834384,2183894825,1418780400,1400672683,1682274743,2292765573,1783996990,1868924374,1683650911,1659551324,1874286141,2832482174,1880968032,1764575503,2160618102,1811811921,2039197740,2234427744,1476952867,3628119303,1285971270,2306394670,1265956604,1620328971,1647559311,2129780034,2130474964,3058692651,2056915004,1822712071,2563980784,2075748961,1920276455,2135932117,1056937372,1420141112,3260039741,2398156983,1352528560,1463710415,2134277207,2122718602,2324178727,1613021863,1945532327,1941292105,3318134170,2281986872,3547936224,2607709131,1972037051,1785071472,1994358565,1757517965,2182866904,1761590281,1898304622,1728158144,1782621495,1093882471,1856956684,1914782644,2299644941,1199706784,1759579891,1990882545,1750560163,1522805437,2273504174,2239190725,2047926983,2686578711,1659375431,1772026304,1727194535,2439860924,2453802741,2557879293,1562276384,2153325480,1624961211,1364602331,2675731703,1221479170,1402050852,1891125650,2524695884,2568734090,1427302861,3223648891,1851150850,1800409113,1884764017,2539652725,2231609523,2331512990,2496822432,1800335272,1279883254,2027916713,1830562424,1868176271,1658293304,1820868023,1966501033],"total_numbe":179},
    1971077767: {"ids":[2025394495,1849262134,1663000800,1702079711,1769055402,2960085005,2142825341,3043369172,1745485535,2092190434,1671438565,2530479692,5084712582,3092989471,2589244013,1998122523,3086123731,2174180543,1271113791,2119868492,1747424947,2092198865,2016592141,2041903813,1790534197,1780779662,3478810943,3061024851,2459028692,2527434801,1848230113,1846796981,2992524102,2518758022,2916409401,3005916817,2031899165,3085296061,1863067032,1935198411,1770250412,2491307953,2523690972,1013031152,2905392650,2652978494,2545957572,2412127457,2947911292,2735365844,2842578254,1785461077,2803414672,2610466201,1769706921,2771679935,2257967430,2211270300,1280197301,1798459404,2072599453,2473925841,2512215325,2586914902,2526035621,1815102124],"total_numbe":66},
    1835081243: {"ids":[1924405647,1732155432,1892536603,1765629055,2627327237,2505835712,2532419512,2136502377,1790956841,5303547135,1835053981,1721200865,2658771730,1448970910,1837861561,2129192603,1650038144,1859508802,2011364082,2376116920,1702079711,1890592154,2156550695,2558140282,2774109835,2866546125,1908313495,1836989525,2028328171,1989720411,1684338437,1848934297,1951457304,2365348840,2030086865,2794312011,2066112705,1903251875,1766734115,2479379117,1776487697,1665246364,1412373182,1381491061,2632422791,1551323384,2968460120,2021509783,1889627001,1748120275,1619905711,1564388523,1707438033,1697824552,1536122450,1925365231,2996392690,2149737874,1420141112,2959926993,2035105815,1644214184,2182142402,1708730703,2690747933,1859063352,1849036501,1891597554,3227781252,1890380215,2606278637,1785654593,1714083054,2369084670,1742959322,1657303594,1773811191,1904264861,1747755104,1059199730,1558342471,1573682603,1662495040,2332238020,1593876875,1418677674,1839671925,3340259472,3179565663,2252789192,2428104102,2357105071,1752777330,2242875242,1717740837,1703039743,1821357943,1789392483,2266394554,1859021582,1794352213,1829609871,1875715445,1886092121,2099806834,1834930175,1781677623,2890457902,1764738684,1740082613,1751032194,2153770534,1917455453,1937388837,2425547760,1801495170,2544227530,1895183627,2302049894,1829555853,2112196990,1044481550,1770882435,2468876630,1775245473,2079447643,1827453367,1810011900,2109729080,2426782660,1747790892,1791871971,1795141441,1920262761,1834925041,1921617507,1922708693,2174128807,1861592702,1764253020,1880281194,1738198442,1838826977,2168779042,1992707152,1790705485,1875247311,1565311334,1951760097,1994371505,1651802265,1737431567,1993764794,2103265085,1920096177,1884120034,1222921201,2083645155,2011417540,1773102065,1747673197,1739333703,1908492957,1638535233,1733873443,1872228230,1811489107,1800412017,1704064385,1803740222,1675490955,1706825017,1762301782,1830375813,1748014474,1842655912,1883613034,1825870734,1764427694,1767370364,1881790350,1752815243,1879559421,1653848897,1724951290,1802305004,1745065303,1772819744,1763417500,1722922531,1803576971,1864779303,1916277992,1805745880,1731638065],"total_numbe":195},
    3314094815: {"ids":[2629498221,1702079711,1651557211],"total_numbe":3},
    1265956604: {"ids":[2112418197,2001219343,2713454903,1852035457,1574122511,1678388203,2384735762,1848934297,2825900260,3017021023,2667547537,1833529904,3193895312,1702079711,1052544000,1882249567,2123387657,1620328971,2350413305,1903571803,3722763097,1198031152,2563980784,1795766795,1572720101,1299326211,1204558423,1319594300,1942880257,2005244761,1756563015,1700024517,1869103401,1653417681,1811887693,2838023587,2758581903,2758807261,1714045140,2890509324,2277297057,2321325744,1820038801,66123499,2442615842,1422239570],"total_numbe":46},
    1903571803: {"ids":[1567482793,2184345410,1276267473,2350413305,1702079711,1882249567,1052544000,1658179175,1834144423,1723291787,1265956604,2707302333,1245550212,2385164450,1658183157,1694521092,2978706687,2024315974,1791423762,1223920903,2710960103,2342640487,2478924230,1952809611,1822530933,1292844252,2442929825,1842343393,2436982347,1736403051,1655346190,2090531533,1791224302],"total_numbe":33},
    1882249567: {"ids":[2711295385,2148688754,2468609650,3270239731,5325134210,5461059649,1852035457,1870183597,3017021023,1848934297,2384735762,2825900260,1678388203,1779423217,2292765573,2141876695,1830460687,1775631507,1815184227,1265956604,1702079711,1903571803,1277609480,5139796967,2123387657,2809388067,1574122511,2829024912,2906500750,1907249773,2667547537,2350413305,3484930261,105221,1052544000,1767024964,3378904904,1302308585,1923740271,1890239951,1671491802,1771636363,2174581884,1419466663,2432123870,1761865810,1869103401,1633123237,3360163242,3514435302,1727363984,2053369520,2212864503,1154239033,2404123017,1947578590,1633241622,1752518573,2897366905,2013287711,3157209723,2505774910,2975291485,2963186983,3416894112,1349093004,3220787335,2612004241,2724638787,2085275545,1563379580,2741073124,1651272934,1882885671,1850585983,3149562571,1896603507,2161621230,2817334184,2236602052,2125764903,1767012611,2928146715,2788903031,2973105031,2085248071,2071461695,1766150640,2510885915,2641286571,1909616113,2006625481,1881398697,1949527263,2905434391,2448273617,2784194787,2371959932,1936062545,2246390680,2316166197,2386348624,1945836305,2423679927,2799853850,2106585467,1761136845,2008604847,1972298915,1787995385,1579366994,2612160721,1870253435,1899415823,2041907644,1701044974,1923728074,1608670965,2185696497,1790782215,2290118607,1784617635,1838347842,1828332791,2262694434,2183636994,1780230053,1859356461,2219953060,2206879444,1743668812,2187334023,1230589187,2045176242,2135435122,2047438183,2000878833,2040739072,2107595160,1913643874,1729376237,2117343045,1889374980,1894932700,1849730292,2070286430,1930701384,2036037540,1762149747,1923541527,2095236070,1812010633,2081345601,2081596907,1663276651,2078027237,2068473913,1832352812,2035035644,1907761821,1974245797,2029380913,1905138661,1984468573,1923988742,1891062594,1666469762,1868715213,1550234761],"total_numbe":169}
};
for (var id in mockdatas) {
    if (mockdatas.hasOwnProperty(id)) {
        $.mockjax({
            url: '/api/friendships/moments/members/ids.json?source=445670032&uid=' + id,
            responseText: mockdatas[id]
        });
    }
}
var MAX_FRIENDS_NUM = 10;
var host = '/api';//'http://i2.api.weibo.com/2'; //api/
/**
 * [getFriendUids 根据uid获取好友圈, 上限为MAX_FRIENDS_NUM]
 * @param  {[string]} uid [uid]
 * @return {[Promise]}     [uids]
 */
function getFriendUids(uid) {
    return new Promise(function (resolve) {
        $.getJSON(host + '/friendships/moments/members/ids.json?source=445670032&uid=' + uid)
            .done(function (data) {
                if (data.ids.length > MAX_FRIENDS_NUM) {
                    data.ids.length = MAX_FRIENDS_NUM;
                }
                resolve(data.ids);
            });
    });
}

/**
 * [getUsersByBatch 批量获取用户基本信息]
 * @param  {[Array]} uids [uids 不超过50]
 * @return {[Promise]}      [users]
 */
function getUsersByBatch (uids) {
    return new Promise(function (resolve) {
        $.getJSON(host + '/users/show_batch.json?source=445670032&uids=' + uids.join(','))
            .done(function (data) {
                resolve(data.users);
            });
    });
}

function splitArrayByLimit (arr, limitLength) {
    var ret = [],
        index = 0;
    while (index < arr.length) {
        ret.push(arr.slice(index, index + limitLength));
        index = index + limitLength;
    }
    return ret;
}

// function getUsers (uids) {
//     var users = [];
//     var batchUids = splitArrayByLimit(uids, 50);
//     var requestPromises = batchUids.map(function (ids) {
//         return getUsersByBatch(ids).then(function (data) {
//             users = users.concat(data);
//         });
//     });
//     return new Promise (function (resolve) {
//         Promise.all(requestPromises).then(function () {
//             resolve(users);
//         });
//     });
// }
function getUsers() {
    return new Promise(function (resovle) {
        $.ajax('/src/core/mocks/realUsers.json').done(function (data) {
            resovle(data.users);
        });
    });
}

/**
 * [getUsersTagByBatch 批量获取用户标签]
 * @param  {[Array]} uids [uids 不超过20]
 * @return {[Promise]}      [users]
 */
function getUsersTagByBatch (uids) {
    return new Promise(function (resolve) {
        $.getJSON(host + '/tags/tags_batch.json?source=445670032&uids=' + uids.join(','))
            .done(function (data) {
                resolve(data);
            });
    });
}

// function getUsersTag (uids) {
//     var users = [];
//     var batchUids = splitArrayByLimit(uids, 20);
//     var requestPromises = batchUids.map(function (ids) {
//         return getUsersTagByBatch(ids).then(function (data) {
//             users = users.concat(data);
//         });
//     });
//     return new Promise (function (resolve) {
//         Promise.all(requestPromises).then(function () {
//             resolve(users);
//         });
//     });
// }
// 
function getUsersTag () {
    return new Promise(function (resovle) {
        $.ajax('/src/core/mocks/tags.json').done(function (data) {
            resovle(data);
        });
    });
}

function getLinksByFriends(uid, friends) {
    return friends.map(function (friendId) {
        return {
            sourceUid: uid,
            targetUid: friendId
        };
    });
}

function getSecondaryFriends (uids) {
    var set = [];
    var requestPromises = uids.map(function (uid) {
        return getFriendUids(uid).then(function (friends) {
            set.push({uid: uid, friends: friends});
        });
    });
    return new Promise(function (resolve) {
        Promise.all(requestPromises).then(function () {
            resolve(set);
        });
    });
}

function getRelationNetByUid (uid) {
    var uids = [uid],
        gusers,
        links = [];
    return getFriendUids(uid).then(function (primaryFriends) {
        uids = uids.concat(primaryFriends);
        links = links.concat(getLinksByFriends(uid, primaryFriends));
        return getSecondaryFriends(primaryFriends);
    }).then(function (usersSet) {
        usersSet.forEach(function (item) {
            uids = uids.concat(item.friends);
            links = links.concat(getLinksByFriends(item.uid, item.friends));
        });
        return getUsers(uids);
    }).then(function (users) {
        gusers = users;
        return getUsersTag(uids);
    }).then(function (userstag) {
        var tagsMap = {};
        userstag.forEach(function (tagUser) {
            tagsMap[tagUser.id] = tagUser.tags;
        });
        gusers.forEach(function (user) {
            user.tags = tagsMap[user.id];
        });
        return {
            users: gusers,
            links: links
        };
    });
}

module.exports = {
    getRelationNetByUid: getRelationNetByUid,
    getUsers: getUsers
};